<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DonationAlerts - FSBSOTIK</title>
    <meta name="description" content="Поддержка FSBSOTIK через DonationAlerts">
    
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            background: #050608;
            color: #e6e6e6;
            font-family: "Segoe UI", system-ui, sans-serif;
            line-height: 1.6;
        }
        
        .header {
            width: 100%;
            background: radial-gradient(circle at top, #151820 0, #050608 55%);
            padding: 15px 0;
            border-bottom: 1px solid rgba(212,175,55,0.3);
        }
        
        .container {
            width: 92%;
            margin: auto;
            padding: 40px 0;
        }
        
        .header-frame {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            white-space: nowrap;
            gap: 20px;
        }
        
        .logo-box {
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(212,175,55,0.18), rgba(0,0,0,0.7));
            border-radius: 6px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 0.08em;
            color: #d4af37;
        }
        
        .content-area {
            margin-top: 30px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .main-section {
            background: rgba(5, 8, 12, 0.96);
            border-radius: 10px;
            border: 1px solid rgba(212,175,55,0.45);
            padding: 30px;
        }
        
        .widgets-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .widget-box {
            background: radial-gradient(circle at top, rgba(10,18,28,0.96) 0, rgba(3,5,8,0.96) 60%);
            padding: 14px 18px 16px;
            border-radius: 10px;
            border: 1px solid rgba(0,234,255,0.55);
            box-shadow: 0 0 18px rgba(0,0,0,0.9), 0 0 22px rgba(0,234,255,0.25);
            color: #e6e6e6;
            font-size: 13px;
        }
        
        .widget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(212,175,55,0.3);
        }
        
        .widget-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: #d4af37;
            opacity: 0.95;
        }
        
        .widget-tag {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #00eaff;
            opacity: 0.8;
        }
        
        .widget-main {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .widget-sub {
            font-size: 11px;
            opacity: 0.8;
        }
        
        .widget-bar {
            margin-top: 8px;
            width: 100%;
            height: 5px;
            border-radius: 999px;
            background: rgba(255,255,255,0.06);
            overflow: hidden;
        }
        
        .widget-bar-fill {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, #d4af37, #00eaff);
            width: 0%;
            transition: width 0.4s ease;
        }
        
        .donation-item {
            background: rgba(20,25,35,0.6);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 12px;
            border-left: 3px solid #d4af37;
        }
        
        .donation-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .donation-username {
            font-weight: 600;
            color: #d4af37;
        }
        
        .donation-amount {
            font-weight: 600;
            color: #00eaff;
        }
        
        .donation-message {
            font-size: 14px;
            line-height: 1.4;
            opacity: 0.9;
        }
        
        .btn-donate {
            margin-top: 20px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            border-radius: 8px;
            border: 1px solid #d4af37;
            color: #050608;
            background: linear-gradient(135deg, #d4af37, #ffea9a);
            cursor: pointer;
            transition: 0.2s ease;
            display: block;
            width: 100%;
            text-align: center;
        }
        
        .btn-donate:hover {
            filter: brightness(1.1);
        }
        
        .footer {
            text-align: center;
            padding: 30px 0;
            border-top: 1px solid rgba(212,175,55,0.3);
            color: #888;
            font-size: 12px;
            margin-top: 40px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-frame">
                <div class="logo-box">
                    <div class="logo">DonationAlerts</div>
                </div>
                <div>Поддержка FSBSOTIK</div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="content-area">
            <div class="main-section">
                <h1 style="color: #d4af37; margin-bottom: 20px;">Поддержите FSBSOTIK</h1>
                <p style="margin-bottom: 20px; opacity: 0.8;">Ваша поддержка помогает развивать канал и создавать качественный контент. Все донаты отображаются в реальном времени на стриме.</p>
                
                <div id="latest-donations">
                    <h2 style="color: #00eaff; margin-bottom: 15px; border-bottom: 1px solid rgba(0,234,255,0.3); padding-bottom: 8px;">Последние донаты</h2>
                    <!-- Динамически заполняется через JavaScript -->
                </div>
                
                <button class="btn-donate" id="btn-donate">Сделать донат</button>
            </div>
            
            <div class="widgets-section">
                <div class="widget-box" id="w-goal">
                    <div class="widget-header">
                        <div class="widget-title">Цель стрима</div>
                        <div class="widget-tag" id="w-goal-tag"></div>
                    </div>
                    <div class="widget-main" id="w-goal-main"></div>
                    <div class="widget-sub" id="w-goal-sub"></div>
                    <div class="widget-bar">
                        <div class="widget-bar-fill" id="w-goal-bar"></div>
                    </div>
                </div>
                
                <div class="widget-box" id="w-stats">
                    <div class="widget-header">
                        <div class="widget-title">Статистика сегодня</div>
                        <div class="widget-tag">stats</div>
                    </div>
                    <div class="widget-main" id="w-day-main"></div>
                    <div class="widget-sub" id="w-day-sub"></div>
                </div>
                
                <div class="widget-box" id="w-last-donation">
                    <div class="widget-header">
                        <div class="widget-title">Последний донат</div>
                        <div class="widget-tag">latest</div>
                    </div>
                    <div class="widget-main" id="w-donates-main"></div>
                    <div class="widget-sub" id="w-donates-sub"></div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            &copy; 2026 DonationAlerts. Все права защищены.
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const $ = (sel, scope = document) => scope.querySelector(sel);
            const formatNumber = num => num.toLocaleString('ru-RU');

            // Функция для отображения цели
            function renderGoal(goal) {
                const goalBar = $('#w-goal-bar');
                const goalTag = $('#w-goal-tag');
                const goalSub = $('#w-goal-sub');
                const goalMain = $('#w-goal-main');

                if (!goalBar || !goalTag || !goalSub || !goalMain) return;

                if (!goal) {
                    goalBar.style.width = '0%';
                    goalTag.textContent = '0%';
                    goalSub.textContent = 'Цель не задана';
                    goalMain.textContent = '';
                    return;
                }

                const raised = goal.raised_amount || 0;
                const total = goal.goal_amount || 0;
                const percent = total > 0 ? Math.min(Math.round((raised / total) * 100), 100) : 0;

                goalBar.style.width = percent + '%';
                goalTag.textContent = percent + '%';
                goalSub.textContent = `Собрано: ${formatNumber(raised)}₽ / ${formatNumber(total)}₽`;
                goalMain.textContent = goal.title || '';
            }

            // Загрузка цели
            async function loadGoal() {
                try {
                    const res = await fetch('/api/goal');
                    const data = await res.json();
                    renderGoal(data.ok ? data.goal : null);
                } catch {
                    renderGoal(null);
                }
            }

            // Загрузка последнего доната
            async function loadLatestDonation() {
                const donMain = $('#w-donates-main');
                const donSub = $('#w-donates-sub');

                if (!donMain || !donSub) return;

                try {
                    const res = await fetch('/api/donations/latest');
                    const data = await res.json();

                    if (!data.ok || !data.latest) {
                        donMain.textContent = 'Пока нет донатов';
                        donSub.textContent = '';
                        return;
                    }

                    const d = data.latest;
                    donMain.textContent = `${d.username}: +${formatNumber(d.amount)}₽`;
                    donSub.textContent = d.message || '';

                } catch {
                    donMain.textContent = 'Ошибка загрузки';
                    donSub.textContent = '';
                }
            }

            // Загрузка статистики
            async function loadStats() {
                const dayMain = $('#w-day-main');
                const daySub = $('#w-day-sub');

                try {
                    const res = await fetch('/api/stats');
                    const data = await res.json();

                    if (!data.ok) return;

                    if (dayMain) dayMain.textContent = `${formatNumber(data.day.sum)}₽`;
                    if (daySub) daySub.textContent = `${data.day.count} донатов сегодня`;
                } catch {}
            }

            // Загрузка истории донатов
            async function loadDonationsHistory() {
                try {
                    // Используем тот же endpoint, что и для последнего доната, но получаем все данные
                    const res = await fetch('/api/donations/latest');
                    const data = await res.json();
                    
                    const container = $('#latest-donations');
                    
                    if (!data.ok || !data.latest) {
                        container.innerHTML += '<div class="donation-item">Пока нет донатов</div>';
                        return;
                    }
                    
                    // В реальной реализации здесь должен быть отдельный endpoint для истории,
                    // но используем имеющиеся данные
                    const donation = data.latest;
                    const item = document.createElement('div');
                    item.className = 'donation-item';
                    
                    item.innerHTML = `
                        <div class="donation-header">
                            <span class="donation-username">${donation.username}</span>
                            <span class="donation-amount">+${formatNumber(donation.amount)}₽</span>
                        </div>
                        <div class="donation-message">${donation.message || 'Без сообщения'}</div>
                    `;
                    
                    container.appendChild(item);
                    
                } catch (error) {
                    console.error('Error loading donations history:', error);
                }
            }

            // Инициализация всех виджетов
            loadGoal();
            loadLatestDonation();
            loadStats();
            loadDonationsHistory();

            // Обновление каждые 30 секунд
            setInterval(loadGoal, 30000);
            setInterval(loadLatestDonation, 15000);
            setInterval(loadStats, 60000);

            // Кнопка доната
            const btnDonate = $('#btn-donate');
            
            if (btnDonate) {
                btnDonate.addEventListener('click', async () => {
                    try {
                        // Получаем URL редиректа через API
                        const response = await fetch('https://dalink.to/api/redirect/fsbsotik', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                source: 'donationalerts_page',
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        let redirectUrl = 'https://dalink.to/fsbsotik';
                        
                        if (response.ok) {
                            const data = await response.json();
                            redirectUrl = data.url || redirectUrl;
                        }
                        
                        // Открываем в новой вкладке
                        window.open(redirectUrl, '_blank');
                    } catch (error) {
                        console.error('Error opening donation page:', error);
                        alert('Не удалось открыть форму доната. Пожалуйста, попробуйте позже.');
                    }
                });
            }
        });
    </script>
</body>
</html>
